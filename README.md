# 🎵 音脈分凝クイズ - 聴覚ストリーミング実験システム

## 概要

このプロジェクトは、音のパターンの違いを検出する能力を測定するためのWeb実験システムです。特に「聴覚ストリーム分凝（ストリーミング）」現象に焦点を当てています。実験では、周波数とタイミングが変化する一連の聴覚刺激（「ギャロップ」と呼ばれる）を参加者に提示し、妨害音の中からターゲット音を識別するよう求めます。

### 🎯 主な特徴

- **純音/ピアノ音選択**: 参加者は純音（サイン波）またはピアノ音を選択して実験可能
- **適応的階段法**: 参加者のパフォーマンスに基づいて難易度を自動調整
- **レベル判定システム**: 閾値に基づく能力レベル評価（天才！、すごい音楽家♫、音楽家、凡人👍️）
- **モバイル完全対応**: スマートフォンでも快適に実験可能
- **リアルタイムフィードバック**: オーバーレイ表示による即座の反応フィードバック
- **統計分析**: 最尤推定法（MLE）による心理測定関数の自動生成

システムは参加者登録から試行提示、データ収集、統計分析、結果の可視化まで、実験プロセス全体を自動化します。研究者は周波数分離が聴覚知覚、特にリズムパターンの識別にどのように影響するかについてのデータを効率的に収集できます。

## プロジェクト構成

### コアシステムとサービス

1. **Webアプリケーション（Flask）**: すべてのHTTPリクエスト、セッション管理、実験ロジックを処理するメインサーバーアプリケーション
2. **音声刺激システム**: 純音とピアノ音の2種類から選択可能な音声提示システム
3. **適応的階段法**: 参加者のパフォーマンスに基づいて試行の難易度を調整する適応型テストアルゴリズム
4. **レスポンシブUI**: PC・タブレット・スマートフォンに完全対応した実験インターフェース
5. **リアルタイムフィードバック**: Level UP🔥/Level DOWN⬇️などの即座の視覚フィードバック
6. **データ収集と保存**: 参加者の反応を記録し、CSVファイルとして保存するメカニズム
7. **統計分析とレベル判定**: 最尤推定法（MLE）による知覚閾値計算と能力レベル評価
8. **データ可視化**: 刺激強度と知覚の関係を示す心理測定関数プロットの生成

### メインファイルとディレクトリ

- **`app.py`**: ルーティング、セッション管理、実験ロジックを処理するメインFlaskアプリケーション。
- **`templates/`**: 異なる実験段階のHTMLテンプレートを含むディレクトリ：
  - **`index.html`**: 参加者データが収集される初期設定ページ。
  - **`practice.html`**: 参加者がタスクに慣れるための練習セッション。
  - **`experiment.html`**: 試行が提示されるメイン実験インターフェース。
  - **`break_page.html`**: 実験ブロック間に表示されるページ。
  - **`complete.html`**: 実験完了後に表示される結果ページ。
- **`static/`**: 静的アセットを含むディレクトリ：
  - **`css/styles.css`**: レスポンシブデザイン対応のスタイリング
  - **`stimuli/`**: 実験用音声ファイル
    - **`successive_0.52*4/`**: 純音ファイル（gallops_*.wav）
    - **`piano_successive_0.52*4/`**: ピアノ音ファイル（piano_gallops_*.wav）
    - **`silence/`**: 音声初期化用無音ファイル
  - **`sample_fig/`**: 生成された図形と視覚化
- **`analysis_MLE_v2.py`**: 実験データに対して最尤推定分析を実行するモジュール。
- **`fig_compare.R`**: 異なる周波数条件間で結果を比較するためのRスクリプト。
- **`requirements.txt`**: アプリケーションを実行するために必要なPython依存関係。

### メイン機能/クラス

1. **セッション管理機能**:
   - `start_experiment()`: 参加者データと音の種類選択に基づいて実験セッションを初期化
   - `initialize_condition_session()`: 各周波数条件のパラメータを設定
   - `set_data_file_path()`: データファイルを保存するためのパスを確立
   - `get_audio_settings()`: 純音/ピアノ音に応じた音声パスを決定

2. **実験ロジック機能**:
   - `next_trial()`: 現在のパラメータに基づいて次の試行のデータを生成
   - `submit_response()`: 参加者の反応を処理し、レベルアップ/ダウンフィードバックを提供
   - `next_block()`: 次の周波数条件に移行
   - `complete()`: 最終分析を実行し、レベル判定付きの結果を生成

3. **階段法プロシージャ機能**:
   - `decide_step_size()`: パフォーマンスに基づいて難易度調整幅を決定

4. **分析とレベル判定機能**:
   - `perform_mle_analysis()`: 心理測定関数のパラメータを推定するためにMLEを適用
   - `calc_threshold()`: フィットされたモデルから75%検出閾値を計算
   - `get_level()`: log2閾値に基づいて能力レベル（天才！～凡人👍️）を判定

## セットアップと実行方法

1. リポジトリをクローンします:
   ```
   git clone https://github.com/Takaya46/sound_exp_stream_segregation.git
   cd sound_exp_stream_segregation
   ```

2. 依存関係をインストールします:
   ```
   pip install -r requirements.txt
   ```

3. Flaskアプリケーションを実行します:
   ```
   python app.py
   ```

4. ブラウザで`http://localhost:5000`にアクセスして実験を開始します。

## 使用方法

### 🖥️ PC版での操作
1. **実験設定**: トップページで参加者ID、音の種類（純音/ピアノ音）、実験条件、問題数を選択
2. **練習セッション**: タスクに慣れるための練習問題を実行
3. **本実験**: 3つの音を聞いて、どの音（1番目または3番目）がターゲット音かを識別
4. **キー操作**: Fキー（1番目）/Jキー（3番目）で選択、スペースキーで送信
5. **結果表示**: 全ブロック完了後、レベル判定付きの結果と心理測定曲線を表示

### 📱 モバイル版での操作
1. **タッチ操作**: 画面上のボタンをタップして操作
2. **最適化されたUI**: 小画面に最適化されたレイアウトで快適な実験体験
3. **ワンタップ送信**: 1st/3rdボタン選択後、決定ボタンで簡単送信

### 🎵 音の種類
- **純音**: 聞き取りやすいサイン波音（推奨：初回参加者）
- **ピアノ音**: より自然で音楽的な音色（推奨：音楽経験者）

## レベル判定システム 🏆

実験完了後、75%検出閾値に基づいて以下の能力レベルが判定されます：

### 📊 判定基準
- **同じ音・半音上**: 0-2: 天才！🌟 | 2-2.5: エキスパート🎯 | 2.5-3: スキルド💪 | 3-: ファイター⚡
- **1オクターブ**: -2.5: 天才！🌟 | 2.5-3.0: エキスパート🎯 | 3-3.5: スキルド💪 | 3.5-: ファイター⚡  
- **2・3オクターブ**: -3: 天才！🌟 | 3-4: エキスパート🎯 | 4-5: スキルド💪 | 5-: ファイター⚡

## コードベース特有の用語集

- **オフセット**: ターゲットと妨害音の間の時間差（ミリ秒単位）
- **階段法プロシージャ**: 参加者の反応に基づいて難易度を調整する適応型テスト方法
- **反転**: 難易度調整の方向が変わるポイント（ステップサイズの調整に使用）
- **ブロック**: 同じ周波数条件を持つ試行のグループ
- **試行**: 参加者の反応を必要とする刺激の単一提示
- **ターゲット音**: 参加者が識別する必要があるリズム変化を含む音
- **通常音**: リズム変化のない標準音（妨害音として使用）
- **周波数条件**: ターゲットとマスクの間の異なる周波数関係（g_base、g_1octave など）
- **MLE**: 知覚閾値を推定するための統計的手法である最尤推定法
- **心理測定曲線**: 刺激強度と正答確率の関係を示すグラフ
- **純音/ピアノ音**: 実験で使用する2種類の音色選択
- **レベル判定**: log2閾値に基づく音楽的聴覚能力の評価システム

## 技術仕様

- **フロントエンド**: HTML5, CSS3 (レスポンシブデザイン), JavaScript (ES6+)
- **バックエンド**: Python Flask
- **音声処理**: Web Audio API
- **統計分析**: SciPy, NumPy, Matplotlib
- **データ保存**: CSV形式
- **対応ブラウザ**: Chrome, Firefox, Safari, Edge (モバイルブラウザ含む)

---

**開発**: 京都大学 西田研究室  
**ライセンス**: 研究用途