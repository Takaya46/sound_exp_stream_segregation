<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --gradient-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border-color: rgba(255, 255, 255, 0.2);
            --shadow-light: 0 10px 25px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        body {
            background: var(--gradient-bg) !important;
            min-height: 100vh;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        h1 {
            background: linear-gradient(45deg, #fff, #f0f8ff) !important;
            -webkit-background-clip: text !important;
            -webkit-text-fill-color: transparent !important;
            background-clip: text !important;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3) !important;
            font-size: 2.4rem !important;
            font-weight: 700 !important;
            margin: 1.5rem 0 1rem 0 !important;
            letter-spacing: -0.02em !important;
            text-align: center !important;
        }

        .container {
            background: rgba(255, 255, 255, 0.9) !important;
            border-radius: 20px !important;
            padding: 2rem !important;
            margin: 1.5rem auto !important;
            max-width: 720px !important;
            width: 92% !important;
            box-shadow: var(--shadow-medium) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            backdrop-filter: blur(15px) !important;
        }

        .dropdowns {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .selector { display: flex; flex-direction: column; align-items: flex-start; gap: 0.4rem; }
        .selector-label { color: var(--text-secondary); font-size: 0.9rem; padding-left: 0.25rem; }

        select {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            min-width: 220px;
            text-align: center;
        }

        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            min-width: 120px;
        }

        .button:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }

        /* Answer buttons: clearer hover/selected state */
        .answer-button { position: relative; }
        .answer-button:hover { filter: brightness(1.03); }
        .answer-button.selected {
            background: linear-gradient(135deg, var(--accent-color), #ff6b9d);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 10px 22px rgba(240, 147, 251, 0.35);
        }
        .answer-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.35), var(--shadow-medium);
        }

        .trial-container { text-align: center; margin-top: 1rem; }
        .button-container { display: flex; gap: 1rem; justify-content: center; margin: 1rem 0; }

        #resultText { color: var(--text-primary); font-size: 1.1rem; font-weight: 600; text-align: center; }
        #error { color: #e53e3e; text-align: center; font-weight: 500; margin: 0.5rem 0; }

        .result-img { max-width: 520px; width: 95%; height: auto; }

        /* Subtle back button */
        .back-link {
            display: inline-block;
            margin: 0.5rem auto 2rem auto;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.95rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
        }
        .back-link:hover { background: rgba(255,255,255,0.9); transform: translateY(-1px); }

        @media (max-width: 768px) {
            h1 { font-size: 2rem !important; }
            .container { padding: 1.25rem !important; }
            select { min-width: 180px; }
        }
    </style>
</head>

<body>
    <h1>Demo</h1>

    <div class="container">
        <p style="text-align:center; margin-top:0; color: var(--text-secondary);">
            Pick the tone difference and delay amount, then play a trial. Press F for 1st or J for 3rd.
        </p>

        <div class="dropdowns">
            <div class="selector">
                <label for="frequencyDirSelect" class="selector-label">Tone difference</label>
                <select id="frequencyDirSelect" aria-label="Tone difference">
                    <option value="g_base">Same Tone</option>
                    <option value="as_semitone">Semitone</option>
                    <option value="g_1octave">1 Octave</option>
                    <option value="g_2octave" selected>2 Octaves</option>
                    <option value="g_3octave">3 Octaves</option>
                </select>
            </div>
            <div class="selector">
                <label for="offsetSelect" class="selector-label">Delay amount</label>
                <select id="offsetSelect" aria-label="Delay amount">
                    <option value="64.00" selected>Big delay</option>
                    <option value="32.00">Medium delay</option>
                    <option value="8.00">Small delay</option>
                </select>
            </div>
            <button id="startDemoBtn" class="button" onclick="startDemoTrial()">Play Trial</button>
        </div>

        <div id="trialArea" class="trial-container" style="display:block;">
            <div class="button-container">
                <button id="buttonF" class="button answer-button" aria-pressed="false">1st</button>
                <button id="buttonJ" class="button answer-button" aria-pressed="false">3rd</button>
            </div>
            <div class="button-container">
                <button id="buttonSubmit" class="button">Submit</button>
            </div>
            <div id="error"></div>
            <h3 id="resultText"></h3>
            <div id="resultImage"></div>
            <div class="button-container">
                <button id="replayBtn" class="button" onclick="replayTrial()" style="display:none;">Replay</button>
            </div>
        </div>
    </div>

    <div style="text-align:center;">
        <a class="back-link" href="{{ url_for('index') }}">Back to Home</a>
    </div>

    <script>
        let selectedKey = null;
        let isTrialRunning = false;
        let isAudioPlaying = false;
        let demoTarget = null;  // 'f' or 'j'
        let currentTonePaths = null;

        document.getElementById("buttonF").addEventListener("click", () => selectKey('f'));
        document.getElementById("buttonJ").addEventListener("click", () => selectKey('j'));
        document.getElementById("buttonSubmit").addEventListener("click", submitAnswer);

        document.addEventListener('keydown', (event) => {
            if (event.key.toLowerCase() === 'f') selectKey('f');
            if (event.key.toLowerCase() === 'j') selectKey('j');
            if (event.code === 'Space') { event.preventDefault(); submitAnswer(); }
        });

        function selectKey(key) {
            selectedKey = key;
            const btnF = document.getElementById('buttonF');
            const btnJ = document.getElementById('buttonJ');
            btnF.classList.remove('selected');
            btnJ.classList.remove('selected');
            btnF.setAttribute('aria-pressed', 'false');
            btnJ.setAttribute('aria-pressed', 'false');
            if (key === 'f') {
                btnF.classList.add('selected');
                btnF.setAttribute('aria-pressed', 'true');
                btnF.focus();
            } else if (key === 'j') {
                btnJ.classList.add('selected');
                btnJ.setAttribute('aria-pressed', 'true');
                btnJ.focus();
            }
            document.getElementById("error").innerText = "";
        }

        function clearSelection() {
            selectedKey = null;
            const btnF = document.getElementById('buttonF');
            const btnJ = document.getElementById('buttonJ');
            btnF.classList.remove('selected');
            btnJ.classList.remove('selected');
            btnF.setAttribute('aria-pressed', 'false');
            btnJ.setAttribute('aria-pressed', 'false');
        }

        function startDemoTrial() {
            // Clear any previous selection to avoid confusion during playback
            clearSelection();
            const frequencyDir = document.getElementById('frequencyDirSelect').value;
            const offsetStr = document.getElementById('offsetSelect').value; // e.g., '64.00'

            document.getElementById('resultText').innerText = '';
            document.getElementById('resultImage').innerHTML = '';
            document.getElementById('replayBtn').style.display = 'none';

            // Target position random: 1 or 3
            const targetPosition = Math.random() < 0.5 ? 1 : 3;
            demoTarget = (targetPosition === 1) ? 'f' : 'j';

            const audioDir = 'successive_0.52*4';
            const filePrefix = 'gallops_';

            let tone1Path, tone2Path, tone3Path;
            if (targetPosition === 1) {
                tone1Path = `/static/stimuli/${audioDir}/${frequencyDir}/${filePrefix}${offsetStr}ms.wav`;
                tone2Path = `/static/stimuli/${audioDir}/${frequencyDir}/${filePrefix}0.00ms.wav`;
                tone3Path = `/static/stimuli/${audioDir}/${frequencyDir}/${filePrefix}0.00ms.wav`;
            } else {
                tone1Path = `/static/stimuli/${audioDir}/${frequencyDir}/${filePrefix}0.00ms.wav`;
                tone2Path = `/static/stimuli/${audioDir}/${frequencyDir}/${filePrefix}0.00ms.wav`;
                tone3Path = `/static/stimuli/${audioDir}/${frequencyDir}/${filePrefix}${offsetStr}ms.wav`;
            }

            currentTonePaths = { tone1: tone1Path, tone2: tone2Path, tone3: tone3Path };

            isTrialRunning = true;
            isAudioPlaying = true;

            const audio1 = new Audio(tone1Path);
            const audio2 = new Audio(tone2Path);
            const audio3 = new Audio(tone3Path);

            // Insert 0.2s of silence (two 0.1s files) to avoid initial noise
            const silencePath = '/static/stimuli/successive_0.52*4/silence/silence_0.1s.wav';
            const s1 = new Audio(silencePath);
            const s2 = new Audio(silencePath);

            s1.play().catch(()=>{});
            s1.onended = () => {
                s2.play().catch(()=>{});
                s2.onended = () => {
                    audio1.play();
                    audio1.onended = () => {
                        setTimeout(() => {
                            audio2.play();
                            audio2.onended = () => {
                                setTimeout(() => {
                                    audio3.play();
                                    audio3.onended = () => { isAudioPlaying = false; };
                                }, 500);
                            };
                        }, 500);
                    };
                };
            };
        }

        function replayTrial() {
            // Clear selection on replay as well
            clearSelection();
            if (!currentTonePaths || isAudioPlaying) return;
            isTrialRunning = true;
            isAudioPlaying = true;

            const audio1 = new Audio(currentTonePaths.tone1);
            const audio2 = new Audio(currentTonePaths.tone2);
            const audio3 = new Audio(currentTonePaths.tone3);

            // Insert 0.2s of silence (two 0.1s files) to avoid initial noise
            const silencePath = '/static/stimuli/successive_0.52*4/silence/silence_0.1s.wav';
            const s1 = new Audio(silencePath);
            const s2 = new Audio(silencePath);

            s1.play().catch(()=>{});
            s1.onended = () => {
                s2.play().catch(()=>{});
                s2.onended = () => {
                    audio1.play();
                    audio1.onended = () => {
                        setTimeout(() => {
                            audio2.play();
                            audio2.onended = () => {
                                setTimeout(() => {
                                    audio3.play();
                                    audio3.onended = () => { isAudioPlaying = false; };
                                }, 500);
                            };
                        }, 500);
                    };
                };
            };
        }

        function submitAnswer() {
            const errorElement = document.getElementById('error');
            const replayBtn = document.getElementById('replayBtn');
            const resultText = document.getElementById('resultText');
            const resultImage = document.getElementById('resultImage');

            if (!isTrialRunning) {
                errorElement.innerText = 'No trial is playing. Press Play Trial.';
                return;
            }
            if (isAudioPlaying) {
                errorElement.innerText = 'Audio is playing. Please wait.';
                setTimeout(() => { errorElement.innerText = ''; }, 1000);
                return;
            }
            if (!selectedKey) {
                errorElement.innerText = 'Please choose F (1st) or J (3rd).';
                setTimeout(() => { errorElement.innerText = ''; }, 1000);
                return;
            }

            if (selectedKey === demoTarget) {
                if (demoTarget === 'f') {
                    resultText.innerText = 'Correct! Target was 1st.';
                    resultImage.innerHTML = "<img src='static/sample_fig/trial_target_first.png' class='result-img'>";
                } else {
                    resultText.innerText = 'Correct! Target was 3rd.';
                    resultImage.innerHTML = "<img src='static/sample_fig/trial_target_third.png' class='result-img'>";
                }
            } else {
                if (demoTarget === 'f') {
                    resultText.innerText = 'Incorrect… Target was 1st.';
                    resultImage.innerHTML = "<img src='static/sample_fig/trial_target_first.png' class='result-img'>";
                } else {
                    resultText.innerText = 'Incorrect… Target was 3rd.';
                    resultImage.innerHTML = "<img src='static/sample_fig/trial_target_third.png' class='result-img'>";
                }
            }

            errorElement.innerText = '';
            if (replayBtn) replayBtn.style.display = 'inline-block';
            selectedKey = null;
        }
    </script>
</body>

</html>
